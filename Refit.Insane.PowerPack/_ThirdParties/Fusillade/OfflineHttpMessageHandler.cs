// From: https://github.com/paulcbetts/Fusillade/blob/master/src/Fusillade/OfflineHttpMessageHandler.cs
// This file isn't generated, but this comment is necessary to exclude it from StyleCop analysis.
// <auto-generated/>

using System;
using System.Net;
using System.Net.Http;
using System.Threading;
using System.Threading.Tasks;

namespace Fusillade
{
    public class OfflineHttpMessageHandler : HttpMessageHandler
    {
        readonly Func<HttpRequestMessage, string, CancellationToken, Task<byte[]>> retrieveBody;

        public OfflineHttpMessageHandler(Func<HttpRequestMessage, string, CancellationToken, Task<byte[]>> retrieveBodyFunc)
        {
            retrieveBody = retrieveBodyFunc;
        }

        protected override async Task<HttpResponseMessage> SendAsync(HttpRequestMessage request, CancellationToken cancellationToken)
        {
            var retrieveBody = this.retrieveBody;
            if (retrieveBody == null && NetCache.RequestCache != null)
            {
                retrieveBody = NetCache.RequestCache.Fetch;
            }

            if (retrieveBody == null)
            {
                throw new Exception("Configure NetCache.RequestCache before calling this!");
            }

            var body = await retrieveBody(request, RateLimitedHttpMessageHandler.UniqueKeyForRequest(request), cancellationToken);
            if (body == null)
            {
                return new HttpResponseMessage(System.Net.HttpStatusCode.ServiceUnavailable);
            }

            var byteContent = new ByteArrayContent(body);
            return new HttpResponseMessage(HttpStatusCode.OK) { Content = byteContent };
        }
    }
}